<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="A cryptocurrency that has just one single coin in circulation.">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>OneSingleCoin</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="product.css" rel="stylesheet">
  </head>

  <body>

    <div class="position-relative overflow-hidden p-3 p-md-5 m-md-3 text-center bg-light">
      <div class="col-md-5 p-lg-5 mx-auto my-5">
        <h1 class="display-4 font-weight-normal">OneSingleCoin</h1>
        <p class="lead font-weight-normal">A cryptocurrency that has just one single coin in circulation.</p>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3">
      <div class="bg-dark mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center text-white overflow-hidden">
        <div class="my-3 py-3">
          <div class="row text-center">
            <div class="col-4">
              <h1 class="price-cont"></h1>
              <div>Current Price</div>
              <div>&asymp; 160$</div>
            </div>

            <div class="col-4">
              <h1>1 coin</h1>
              Total Supply
            </div>

            <div class="col-4">
              <h1 class="price-cont"></h1>
              Market Cap = Price &times; Supply
              <div>&asymp; 160$</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden">
        <div class="my-3 py-3">
          <h2 class="display-5">The rules</h2>
          <p class="lead">Each time someone buys the OneSingleCoin, its price goes up by 20%.<br/>The seller receives the price minus 8% which gets equally distributed among all the previous owners.</p>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3">
      <div class="bg-primary mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center text-white overflow-hidden">
        <div class="my-3 py-3">
          <h2 class="display-5">To the moon</h2>
          <p class="lead">The primary goal of OneSingleCoin is to become a cryptocurrency with the biggest price.<br/>Because fuck you, Bitcoin.</p>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden buy-section d-none">
        <div class="my-3 py-3">
          <h2 class="display-5">Buy the OneSingleCoin</h2>
          <div class="row">
            <div class="col-6 offset-3">
              <textarea type="text" placeholder="Write a message you would like to immortalize in blockchain" class="form-control mt-4" autofocus id="message"></textarea>
              The message could be an ad, <a href="https://www.reddit.com/r/cryptocurrencymemes/" target="_blank">a meme</a> or anything else. However we won't publish any offensive things.
              <div>
                <a class="btn btn-outline-primary buy-btn btn-lg mt-4 mb-5" href="#">Buy OneSingleCoin</a>
              </div>

              <div class="alert alert-warning d-none" id="transaction-sending-alert">
                Confirm the transaction in MetaMask to complete the purchase. Once you submit, please wait a bit until the transaction is sent.
              </div>

              <div class="alert alert-info d-none" id="transaction-sent-alert">
                The transaction has been sent to the network. Once its mined, you will be the owner of OneSingleCoin. You can check the status of transaction on etherscan: <span class="link-placeholder"></span></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden howtobuy-section">
        <div class="my-3 py-3">
          <h2 class="display-5">How to buy?</h2>
          <p class="lead install-metamask-warning">Install <a href="https://metamask.io/">Metamask</a> and add enough funds to your account to buy the coin. If you have installed Metamask, ensure you're logged in.</p>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3 d-none" id="message3">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden d-none message-cont">
        <div class="my-3 py-3">
          <h5 class="display-5">The message from the 3d Hodler of OneSingleCoin:</h5>
          <p class="lead"></p>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3 d-none" id="message2">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden d-none message-cont">
        <div class="my-3 py-3">
          <h5 class="display-5">The message from the 2d Hodler of OneSingleCoin:</h5>
          <p class="lead"></p>
        </div>
      </div>
    </div>

    <div class="d-md-flex flex-md-equal w-100 my-md-3 pl-md-3 d-none" id="message1">
      <div class="bg-light mr-md-3 pt-3 px-3 pt-md-5 px-md-5 text-center overflow-hidden d-none message-cont">
        <div class="my-3 py-3">
          <h5 class="display-5">The message from the 1st Hodler of OneSingleCoin:</h5>
          <p class="lead"></p>
        </div>
      </div>
    </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="assets/js/vendor/popper.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="assets/js/vendor/holder.min.js"></script>
    <script>
      Holder.addTheme('thumb', {
        bg: '#55595c',
        fg: '#eceeef',
        text: 'Thumbnail'
      });
    </script>

    <script src="assets/js/vendor/web3.min.js"></script>
    <script>
        var abi = [
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "message",
                        "type": "string"
                    }
                ],
                "name": "buy",
                "outputs": [
                    {
                        "name": "",
                        "type": "bool"
                    }
                ],
                "payable": true,
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "_buyerId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "name": "_buyer",
                        "type": "address"
                    }
                ],
                "name": "Purchased",
                "type": "event"
            },
            {
                "inputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "balance",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "currentHodler",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "currentHodlerId",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "messages",
                "outputs": [
                    {
                        "name": "",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "previousHodlers",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "price",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];
        var contract_address = '0x5987c741e7e94b35a93abcefcce95e51e8d3d723';
        var web3 = null;
        var contract;
        var lastHodlerId = -1;

        $(document).ready(function() {
            web3 = new Web3(Web3.givenProvider || "ws://localhost:8546");
            if (web3) {
                startApp(web3);
                //alert("Web3");
            }
        });

        function toggleMetamaskAlert(toggle) {
            $('.buy-section').toggleClass('d-none', toggle);
            $('.howtobuy-section').toggleClass('d-none', !toggle);
        }

        function updateMessage(i) {
            contract.methods.messages(i).call(function (error, res) {
                console.log('msg', i, res);
                var number = i + 1;
                if (!error) {
                    $('#message' + number).find('.lead').html(res);
                    $('#message' + number).find('.message-cont').removeClass('d-none');
                }
            });
        }

        function updateView() {
              contract.methods.price().call(function(error, res) {
                  if (!error) {
                      $('.price-cont').html(Math.floor(res / Math.pow(10, 14)) / 10000);
                  }
              });

              contract.methods.currentHodlerId().call(function(error, currentHodlerId) {
                  //todo: need to update lastHodler at the end only if all the placeholders are filled

                  console.log('current hodler id', currentHodlerId, error);
                  if (error) {
                      return;
                  }
                  for (var i = lastHodlerId + 1; i < currentHodlerId; i++) {
                      updateMessage(i);
                  }
              });
        }

        function startApp(web3) {
            toggleMetamaskAlert(false);
            contract = new web3.eth.Contract(abi, contract_address);

            updateView();
            setInterval(updateView  , 10000);

            //todo: withdrawal button (only if the user has some non-zero balance)
            $('.buy-btn').on('click', function(e) {
                e.preventDefault();
                web3.eth.getAccounts(function(err, accounts) {
                    var address = accounts[0];
                    if (!address) {
                        return toggleMetamaskAlert(true);
                    }

                    contract.methods.price().call(function(error, res) {
                        if (error) {
                            return;
                        }
                        $('#transaction-sending-alert').removeClass('d-none');
                        contract.methods.buy($('#message').val()).send({ from: address, value: res })
                            .then(function (txHash) {
                                console.log(txHash);
                                $('#transaction-sending-alert').addClass('d-none');
                                $('#transaction-sent-alert').removeClass('d-none')
                                    .find('.link-placeholder').html('<a href="https://etherscan.io/tx/' + txHash.transactionHash + '">' + txHash.transactionHash + '</a>');
                            })
                            .catch(console.error)
                    });
                });
            })
        }

    </script>
  </body>
</html>
